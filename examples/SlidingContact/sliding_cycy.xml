<msml:msml xmlns:msml="http://sfb125.de/msml"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://sfb125.de/msml ../../test.xsd">
    <variables>
        <var name="input_cube_file" value="cycytubeImage.vtk" logical="Image"
             physical="str"/>	
		<var name="replaced_mat_cube_file" value="replaced_mat_image.vti" logical="Image"
             physical="str"/>				 
		<var name="output_mesh_file" value="meshed_volume.vtk" logical="Mesh"/>   
		<var name="output_forces_mesh_file" value="meshed_forces_volume.vtk" logical="Mesh"/>    		
		<var name="output_moving_volume" value="moving_volume.vtk" logical="Mesh"
             physical="str"/>	
		<var name="output_fixed_volume" value="fixed_volume.vtk" logical="Mesh"
             physical="str"/>	
		<var name="output_fixed_forces_volume" value="fixed_forces_volume.vtk" logical="Mesh"
             physical="str"/>	
		<var name="output_moving_forces_volume" value="moving_forces_volume.vtk" logical="Mesh"
             physical="str"/>	
		<var name="output_moving_surface" value="moving_surface.vtk" logical="Mesh"
             physical="str"/>	
		<var name="output_fixed_surface" value="fixed_surface.vtk" logical="Mesh"
             physical="str"/>	 
    </variables>
	<scene>
		<object id="moving">
		    <mesh>
				<linearTet id="movingMesh" mesh="${MovingForcesSplit}"/>
            </mesh>
          	<contactsurface id="contactSurface" surface="${MovingSurface}"/>			
			
			<sets>	
				<surfaces>
                   <indexgroup id="pistonASurface" indices="${pistonAMatIds}"/>
                </surfaces>				
			</sets>		
			<material>	
				<region id="pistonAMaterial" indices="${pistonAMatIds}">
                    <linearElasticMaterial youngModulus="2200" poissonRatio="0.45"/>
                    <mass massDensity="0.001"/>
                </region>		
				 <region id="pistonBMaterial" indices="${pistonBMatIds}">
                    <linearElasticMaterial youngModulus="2000" poissonRatio="0.45"/>
                    <mass massDensity="0.001"/>
                </region>		
            </material>		
			<constraints>		
				<constraint name="test" forStep="${initial}">                    
					<surfacePressureOnMesh mesh="${SurfacePressureExtractor}" indices="${pressureIndices}" pressure="3000"/>				
                </constraint>									
			</constraints>				
			<output>
                <displacement id="movingMesh" timestep="1"/>
            </output>		
        </object>
		<object id="fixed">
		    <mesh>
				<linearTet id="fixedMesh" mesh="${FixedForcesSplit}"/>
            </mesh>
          	<contactsurface id="contactSurface" surface="${FixedSurface}"/>			
			
			<sets>	
				<surfaces>
                   <indexgroup id="cylinderSurface" indices="${cylinderMatIds}"/>
                </surfaces>				
			</sets>		
			<material>	
			 <region id="cylinderMaterial" indices="${cylinderMatIds}">
                    <linearElasticMaterial youngModulus="2200" poissonRatio="0.45"/>
                    <mass massDensity="0.001"/>
                </region>			
            </material>		
			<constraints>		
				<constraint name="test" forStep="${initial}">                    
					<fixedConstraint indices="${bottomToIndexGroup}"/>				
                </constraint>									
			</constraints>	
			<output>
                <displacement id="fixedMesh" timestep="1"/>
            </output>		
        </object>		
	</scene>
    <workflow>		
		<!-- forces geometry--> 
		<CGALMeshVolumeFromVoxels id="VolumeForcesMesher" meshFilename="${output_forces_mesh_file}" image="cycytubeImage.vtk"
                       facetAngle="15" facetSize="3" facetDistance="2" cellSize="8"
                       cellRadiusEdgeRatio="3"  odt="false" lloyd="false" pertube="false"
                       exude="false"/>	
		<!-- select fixed part, outside and cylinder -->			   
		<SelectVolumesByMaterialID id="FixedForcesSplit" selectedVolumesFilename="${output_fixed_forces_volume}" 
													mesh="${VolumeForcesMesher}" group="0 1"/>
		<!-- select moving part, pistons -->
		<SelectVolumesByMaterialID id="MovingForcesSplit" selectedVolumesFilename="${output_moving_forces_volume}" 
										mesh="${VolumeForcesMesher}" group="2 3"/>			
		
		<ComputeIndicesFromBoxROI id="bottomToIndexGroup"
								   box="25 9.4 8.4 72.4 16.4 88.5" mesh="${FixedForcesSplit}"
								   select="points"/>		
		<!--<ComputeIndicesFromMaterialId id="cylinderPointIds" num="1" mesh="${FixedForcesSplit}" type="faces" />-->
		<ComputeIndicesFromMaterialId id="cylinderMatIds" num="1" mesh="${FixedForcesSplit}" type="elements" />
		<ComputeIndicesFromMaterialId id="pistonAMatIds" num="2" mesh="${MovingForcesSplit}" type="elements" />	
		<ComputeIndicesFromMaterialId id="pistonBMatIds" num="3" mesh="${MovingForcesSplit}" type="elements" />	
					   
		<!-- contact geometry-->
		<!-- 0 is outside, 1 is cylinder body, 2 is smaller piston, 3 is larger piston
			 piston material ids get replaced by same material id: (2,3)->42
		-->
		<ReplaceMaterialID id="ReplaceMovingID" image="cycytubeImage.vtk" replacedImageFile="${replaced_mat_cube_file}" 
						   toReplace="2 3" replaceBy="42"/>
		<!-- mesh with cgal-->
		<CGALMeshVolumeFromVoxels id="VolumeMesher" meshFilename="${output_mesh_file}" image="${ReplaceMovingID}"
                       facetAngle="15" facetSize="3" facetDistance="2" cellSize="8"
                       cellRadiusEdgeRatio="3"  odt="false" lloyd="false" pertube="false"
                       exude="false"/>		
		<!-- select fixed part, outside and cylinder -->			   
		<SelectVolumesByMaterialID id="FixedSplit" selectedVolumesFilename="${output_fixed_volume}" 
													mesh="${VolumeMesher}" group="0 1"/>
		<!-- select moving part, pistons -->
		<SelectVolumesByMaterialID id="MovingSplit" selectedVolumesFilename="${output_moving_volume}" 
										mesh="${VolumeMesher}" group="42"/>			
		<!-- extract surfaces for fixed and moving part -->
		<ExtractSurfaceMesh id="FixedSurface"  mesh="${FixedSplit}"	targetSurfaceMeshFilename="${output_fixed_surface}"/>	
		<!-- extract surfaces for fixed and moving part -->
		<ExtractSurfaceMesh id="MovingSurface"  mesh="${MovingSplit}" targetSurfaceMeshFilename="${output_moving_surface}"/>
		
		<ExtractAllSurfacesByMaterial id="SurfacePressureExtractor" meshIn="${MovingSplit}" 
									   meshOutFilename="testmesh.vtk" cut="false"/> 
									   
		<ComputeIndicesFromMaterialId id="pressureIndices" num="1" 
									  mesh="${SurfacePressureExtractor}" type="faces" />
									  
		<!-- Measure surface volume of cylinder befor simulation -->
		<ExtractSurfaceMesh id="CylinderSurfacePreSim"  
							mesh="${VolumeForcesMesher}"  targetSurfaceMeshFilename="cylinder_surface_presim.vtk"/>						   
		<SurfaceMeshVolume id="CylinderPreSimVolume" mesh="${CylinderSurfacePreSim}"/>		
									  
		<!-- Measure surface volume of cylinder after simulation, should increase -->
		<ExtractSurfaceMesh id="CylinderSurfacePostSim"  
							mesh="${fixedMesh}"  targetSurfaceMeshFilename="cylinder_surface_postsim.vtk"/>						   
		<SurfaceMeshVolume id="CylinderPostSimVolume" mesh="${CylinderSurfacePostSim}"/>	
				
  </workflow>
    <environment>		
        <solver linearSolver="iterativeCG" processingUnit="CPU"
                timeIntegration="dynamicImplicitEuler"/>
        <simulation>
            <step name="initial" dt="0.05" iterations="10" gravity="0 -9.81 0"/>
        </simulation>	
    </environment>
</msml:msml>